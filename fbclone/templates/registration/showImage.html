<!DOCTYPE html>
{% load static %}
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title></title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">
	<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.slim.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
<h2 class="text-center alert alert-info">image</h2>
<div class="row">
	<div class="col-sm-4 offset-4">
		<div class="text-center">
			{% if showimage %}
				{{showimage.author}}<br>
				<strong>{{showimage.title}}</strong><br>
				{{showimage.discription}}<br>
				
			</div>
			<img src="{% if showimage.photo %}{{ showimage.photo.url }}{%else%}#{% endif %}" class="img-responsive" style="width:500px; float: left; margin-right: 10px;"></img><br>
			{% if showimage.author_id == user.id %}
				<a href="{% url 'Updatepost' showimage.id  %}" class="btn btn-warning btn-sm">Update</a>
				<a href="{% url 'deletepost' showimage.id %}" class="btn btn-danger">Delete</a>
			{% endif %}  	
		
				<a href="{% url 'profile' %}" class="btn btn-success">Back</a>
				<button value="{{ showimage.id }}" name="post_id" class="btn btn-primary commenttext" data-toggle="modal" data-target="#addcomment{{ showimage.id }}">
				Add Comment
				</button>
						
				<div class="modal fade" id="addcomment{{ showimage.id }}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
				  <div class="modal-dialog">
				    <div class="modal-content">
				      <div class="modal-header">
				        <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
				        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				      </div>
				      <div class="modal-body">
				        <form action="{% url 'add_comment' %}" method='POST' class="comment-form" id="{{showimage.id}}">
				          {% csrf_token %}
				          <input type="hidden" value="{{ showimage.id }}">
				          <input type="hidden" class="userclass" value="{{ request.user }}">
				          <input type="hidden" value="{{showimage.created_on}}" class="commenttime">
				          <textarea class="form-control" id="id_content{{ showimage.id }}" name="content" rows="4"></textarea>
				          <button type="submit" class=" btn btn-primary ml-2"  id="submit-comment{{ showimage.id }}" value="{{ showimage.id }}" name="post_id">Comment</button>
				        </form>
				      </div>
				    </div>
				  </div>
				</div>
				<h2>Comments...</h2>  
				<div id="comment-section{{ showimage.id }}"> 
					{{res}}
				  {% if not showimage.comments.all %}
				    No comment yet...<br>
				  {% else %}
				    <div class="comment-wrapper" >
				    {% for comment in showimage.comments.all %}
				  
				        <strong>{{ comment.user}}-{{comment.created_on}}</strong><br>
				      
				        {{comment.content}}
				      
				        {% if comment.user_id == user.id %}

				            <a href="{% url 'deletecomment' comment.id %}" >Delete</a>
				         {% else %}
				          
				            <a href="{% url 'notvalid' %}" >Delete</a>
				         {% endif %} 
				        <br>
				         
				    {% endfor %}
				    </div>  
				  {% endif %} 
			{% endif %}	  
		</div><hr>
			</div>
		</div>
<!-- comments area -->

</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script type="text/javascript">
	$(document).ready(function(){
		$('.comment-form').submit(function(e){
			
			e.preventDefault()
			let res='';
			const post_id=$(this).attr('id')
			const url=$(this).attr('action')
			const comment=$(`#id_content${ post_id }`).val()
			const user_id=$('.userclass').val()
			const commentText=$(`.commentarea${post_id}`).text()
			$.ajax({
				type:'POST',
				url:url,
				data:{
					'csrfmiddlewaretoken':$('input[name=csrfmiddlewaretoken]').val(),
					'post_id':post_id,	
					'content':comment,
					'user_id':user_id,				
				},
				success: function(data){
					let comment=data.comment_data
					console.log(comment)
					res+='<strong>'+ data.user+'-'+comment.created_on+'</strong><br>'
        					+comment.content+' '+'<a href='+"/deletecomment/"+ comment.id+' >Delete</a><br>'
					$(`#comment-section${ post_id }`).append(res);
					$(`#addcomment${ post_id }`).hide();
					$(".modal-backdrop").hide();
					$(".comment-form").trigger("reset");
				},
				error : function(response){
					console.log(" error",response)
				},
			})

		});
	});	
</script>
</html>